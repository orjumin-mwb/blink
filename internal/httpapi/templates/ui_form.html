<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blink URL Checker</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3csvg width='38' height='31' viewBox='0 0 38 31' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M32.0027 1.36379C30.6679 0.107605 30.4953 0 30.2403 0C30.1422 0 30.0218 0.0398185 29.9085 0.155956C29.7952 0.272093 19.3001 11.0392 19.3001 11.0392C19.2063 11.1331 19.0859 11.1866 18.9655 11.1866C18.8451 11.1866 18.7247 11.1331 18.6308 11.0392C18.6308 11.0392 8.13579 0.272093 8.02249 0.155956C7.9092 0.0398185 7.78832 0 7.69067 0C7.43564 0 7.26309 0.107605 5.92822 1.36379C3.48128 3.66568 0 9.19524 0 15.0253C0 16.6935 -0.00094754 26.1513 10.2623 30.8551C10.7311 31.0694 11.1928 30.5631 10.8245 30.1858C9.15922 28.4778 7.85231 25.3104 7.85231 22.5809C7.85231 20.2781 8.54867 18.1222 9.7399 16.328C9.91387 16.0199 10.1817 15.9663 10.4898 16.2744C10.4898 16.2744 18.4862 24.3637 18.6204 24.4993C18.7545 24.6354 18.8555 24.6557 18.965 24.6557C19.0745 24.6557 19.1755 24.6349 19.3096 24.4993C19.4438 24.3633 27.4402 16.2744 27.4402 16.2744C27.7483 15.9663 28.0161 16.0199 28.1901 16.328C29.3818 18.1222 30.0777 20.2776 30.0777 22.5809C30.0777 25.3109 28.7708 28.4778 27.1055 30.1858C26.7372 30.5636 27.1994 31.0694 27.6677 30.8551C37.931 26.1513 37.93 16.693 37.93 15.0253C37.93 9.19524 34.4487 3.66615 32.0023 1.36379H32.0027Z' fill='%230059FF'/%3e%3c/svg%3e">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3csvg width='38' height='31' viewBox='0 0 38 31' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M32.0027 1.36379C30.6679 0.107605 30.4953 0 30.2403 0C30.1422 0 30.0218 0.0398185 29.9085 0.155956C29.7952 0.272093 19.3001 11.0392 19.3001 11.0392C19.2063 11.1331 19.0859 11.1866 18.9655 11.1866C18.8451 11.1866 18.7247 11.1331 18.6308 11.0392C18.6308 11.0392 8.13579 0.272093 8.02249 0.155956C7.9092 0.0398185 7.78832 0 7.69067 0C7.43564 0 7.26309 0.107605 5.92822 1.36379C3.48128 3.66568 0 9.19524 0 15.0253C0 16.6935 -0.00094754 26.1513 10.2623 30.8551C10.7311 31.0694 11.1928 30.5631 10.8245 30.1858C9.15922 28.4778 7.85231 25.3104 7.85231 22.5809C7.85231 20.2781 8.54867 18.1222 9.7399 16.328C9.91387 16.0199 10.1817 15.9663 10.4898 16.2744C10.4898 16.2744 18.4862 24.3637 18.6204 24.4993C18.7545 24.6354 18.8555 24.6557 18.965 24.6557C19.0745 24.6557 19.1755 24.6349 19.3096 24.4993C19.4438 24.3633 27.4402 16.2744 27.4402 16.2744C27.7483 15.9663 28.0161 16.0199 28.1901 16.328C29.3818 18.1222 30.0777 20.2776 30.0777 22.5809C30.0777 25.3109 28.7708 28.4778 27.1055 30.1858C26.7372 30.5636 27.1994 31.0694 27.6677 30.8551C37.931 26.1513 37.93 16.693 37.93 15.0253C37.93 9.19524 34.4487 3.66615 32.0023 1.36379H32.0027Z' fill='%230059FF'/%3e%3c/svg%3e">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/blurhash@2.0.5/dist/blurhash.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'heading': ['PP Right Grotesk', 'system-ui', 'sans-serif'],
                        'body': ['Spline Sans', 'system-ui', 'sans-serif']
                    },
                    colors: {
                        'primary-blue': '#0059FF',
                        'dark-blue': '#001B4D',
                        'light-bg': '#D5EEFF'
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Font Imports */
        @font-face {
            font-family: 'PP Right Grotesk';
            src: url('https://www.malwarebytes.com/wp-content/themes/malwarebytes/assets/build/fonts/PPRightGrotesk-CompactDark.b5625601.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Spline Sans';
            src: url('https://www.malwarebytes.com/wp-content/themes/malwarebytes/assets/build/fonts/SplineSans-Regular.7b0c3511.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Spline Sans';
            src: url('https://www.malwarebytes.com/wp-content/themes/malwarebytes/assets/build/fonts/SplineSans-SemiBold.5c8398a6.woff2') format('woff2');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .progress-stage {
            transition: all 0.3s ease;
            font-family: 'Spline Sans', system-ui, sans-serif;
        }

        .stage-active {
            animation: pulse-slow 2s ease-in-out infinite;
            background-color: #001B4D !important;
            color: white !important;
        }

        .progress-stage.stage-complete {
            background-color: #0059FF !important;
            color: white !important;
            border-color: #0059FF !important;
        }

        .stage-error {
            background-color: #ef4444 !important;
            color: white !important;
        }

        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        /* Markdown styling for ScamGuard analysis */
        .markdown-content {
            line-height: 1.6;
            font-family: 'Spline Sans', system-ui, sans-serif;
        }

        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            font-family: 'PP Right Grotesk', system-ui, sans-serif;
            font-weight: 700;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .markdown-content h1 {
            font-size: 1.5em;
        }

        .markdown-content h2 {
            font-size: 1.3em;
        }

        .markdown-content h3 {
            font-size: 1.1em;
        }

        .markdown-content p {
            margin-bottom: 0.75em;
        }

        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5em;
            margin-bottom: 0.75em;
        }

        .markdown-content li {
            margin-bottom: 0.25em;
        }

        .markdown-content strong {
            font-weight: 600;
        }

        .markdown-content em {
            font-style: italic;
        }

        .markdown-content code {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.75em;
            border-radius: 5px;
            overflow-x: auto;
            margin-bottom: 0.75em;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .markdown-content blockquote {
            border-left: 3px solid #d1d5db;
            padding-left: 1em;
            margin-left: 0;
            color: #6b7280;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        /* Screenshot progressive loading styles */
        .screenshot-loaded {
            opacity: 1 !important;
        }

        .screenshot-placeholder-hidden {
            opacity: 0 !important;
        }

        /* Tab System Styles */
        .tab-button {
            transition: all 0.2s ease;
            border-bottom: none;
        }

        .tab-button.active {
            background-color: #001B4D !important;
            color: white !important;
            border-color: #001B4D !important;
        }

        .tab-button:not(.active) {
            background-color: white !important;
            color: #374151 !important;
            border-color: #d1d5db !important;
        }

        .tab-button:not(.active):hover {
            background-color: #f9fafb !important;
            border-color: #001B4D !important;
        }

        .tab-content {
            display: block;
        }

        .tab-content.hidden {
            display: none !important;
        }
    </style>
</head>
<body class="min-h-screen font-body" style="background-color: #D5EEFF;">
    <!-- Initial Centered Form View -->
    <header id="initial-form" class="min-h-screen flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-2xl">
            <!-- Centered Header -->
            <div class="text-center mb-16">
                <!-- Logo -->
                <div class="mb-8">
                    <svg width="76" height="62" viewBox="0 0 38 31" fill="none" xmlns="http://www.w3.org/2000/svg" class="mx-auto">
                        <path d="M32.0027 1.36379C30.6679 0.107605 30.4953 0 30.2403 0C30.1422 0 30.0218 0.0398185 29.9085 0.155956C29.7952 0.272093 19.3001 11.0392 19.3001 11.0392C19.2063 11.1331 19.0859 11.1866 18.9655 11.1866C18.8451 11.1866 18.7247 11.1331 18.6308 11.0392C18.6308 11.0392 8.13579 0.272093 8.02249 0.155956C7.9092 0.0398185 7.78832 0 7.69067 0C7.43564 0 7.26309 0.107605 5.92822 1.36379C3.48128 3.66568 0 9.19524 0 15.0253C0 16.6935 -0.00094754 26.1513 10.2623 30.8551C10.7311 31.0694 11.1928 30.5631 10.8245 30.1858C9.15922 28.4778 7.85231 25.3104 7.85231 22.5809C7.85231 20.2781 8.54867 18.1222 9.7399 16.328C9.91387 16.0199 10.1817 15.9663 10.4898 16.2744C10.4898 16.2744 18.4862 24.3637 18.6204 24.4993C18.7545 24.6354 18.8555 24.6557 18.965 24.6557C19.0745 24.6557 19.1755 24.6349 19.3096 24.4993C19.4438 24.3633 27.4402 16.2744 27.4402 16.2744C27.7483 15.9663 28.0161 16.0199 28.1901 16.328C29.3818 18.1222 30.0777 20.2776 30.0777 22.5809C30.0777 25.3109 28.7708 28.4778 27.1055 30.1858C26.7372 30.5636 27.1994 31.0694 27.6677 30.8551C37.931 26.1513 37.93 16.693 37.93 15.0253C37.93 9.19524 34.4487 3.66615 32.0023 1.36379H32.0027Z" fill="#0059FF"/>
                    </svg>
                </div>
                
                <!-- Main Headline -->
                <div class="mb-10">
                    <h1 class="font-heading font-black text-dark-blue mb-2" style="font-size: 92px; line-height: 90%; letter-spacing: -2%;">
                        Suspicious link?
                    </h1>
                    <h2 class="font-heading font-black" style="font-size: 92px; line-height: 90%; letter-spacing: -2%;">
                        <span class="text-dark-blue">Know in a</span>
                        <span class="text-primary-blue">Blink.</span> 
                    </h2>
                </div>
            </div>

            <!-- Sleek Input Form -->
            <div class="max-w-4xl mx-auto">
                <form id="check-form">
                    <div class="flex bg-white rounded-full shadow-xl p-2 border-2 border-gray-100 hover:border-primary-blue transition-all duration-300">
                        <input type="url"
                               name="url"
                               placeholder="example-suspicious-url.com"
                               required
                               autofocus
                               class="flex-1 px-8 py-4 text-xl font-body text-gray-700 placeholder-gray-400 bg-transparent border-0 focus:outline-none focus:ring-0 focus:bg-white rounded-full">
                        <button type="submit"
                                class="bg-primary-blue text-white px-8 py-4 rounded-full hover:bg-dark-blue transition-all duration-300 font-semibold font-body text-lg flex items-center space-x-2 shadow-lg">
                            <span>Check URL</span>
                            <svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7.79167 11.9167C8.95278 11.9167 9.93056 11.5194 10.725 10.725C11.5194 9.93056 11.9167 8.95278 11.9167 7.79167C11.9167 6.63056 11.5194 5.65278 10.725 4.85833C9.93056 4.06389 8.95278 3.66667 7.79167 3.66667C6.63056 3.66667 5.65278 4.06389 4.85833 4.85833C4.06389 5.65278 3.66667 6.63056 3.66667 7.79167C3.66667 8.95278 4.06389 9.93056 4.85833 10.725C5.65278 11.5194 6.63056 11.9167 7.79167 11.9167ZM7.79167 15.5833C5.62222 15.5833 3.78125 14.8271 2.26875 13.3146C0.756251 11.8021 0 9.96111 0 7.79167C0 5.62222 0.756251 3.78125 2.26875 2.26875C3.78125 0.756249 5.62222 -1.90735e-06 7.79167 -1.90735e-06C9.96111 -1.90735e-06 11.8021 0.756249 13.3146 2.26875C14.8271 3.78125 15.5833 5.62222 15.5833 7.79167C15.5833 8.49444 15.484 9.18958 15.2854 9.87708C15.0868 10.5646 14.7889 11.2139 14.3917 11.825L17.9667 15.4C18.3333 15.7667 18.509 16.1944 18.4937 16.6833C18.4785 17.1722 18.2875 17.6 17.9208 17.9667C17.5542 18.3028 17.1264 18.4785 16.6375 18.4938C16.1486 18.509 15.7208 18.3333 15.3542 17.9667L11.825 14.4375C11.2139 14.8347 10.5646 15.125 9.87708 15.3083C9.18958 15.4917 8.49444 15.5833 7.79167 15.5833Z" fill="white"/>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        </div>

        <!-- Results Section (appears below the form) -->
        <div id="results-section" class="hidden max-w-7xl mx-auto mt-12">
            <!-- Tab Navigation -->
            <div class="flex" style="margin-bottom: -4px;">
                <button id="tab-overview" class="tab-button active px-6 py-3 font-semibold font-heading rounded-tl-lg rounded-tr-lg border-2 border-gray-200 bg-dark-blue text-white" style="font-size: 30px;">
                    Overview
                </button>
                <button id="tab-advanced" class="tab-button px-6 py-3 font-semibold font-heading rounded-tl-lg rounded-tr-lg border-2 border-gray-200 bg-white text-gray-700 ml-1" style="font-size: 30px;">
                    Advanced
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column (2/3 width) - Overview Tab -->
                <div id="results-overview" class="tab-content lg:col-span-2 bg-white rounded-lg shadow-md min-h-[500px] min-w-[52rem]">
                    <div class="p-6">
                        <!-- Progress Indicators (inside Overview tab) -->
                        <div id="progress-container" class="mb-6 hidden">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm font-semibold text-gray-700 font-body">Progress</div>
                                <div class="flex flex-wrap gap-2">
                                    <span id="stage-dns" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">DNS</span>
                                    <span id="stage-tcp" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">TCP</span>
                                    <span id="stage-tls" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">TLS</span>
                                    <span id="stage-response" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">Response</span>
                                    <span id="stage-scamguard" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">AI</span>
                                </div>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progress-bar" class="progress-bar bg-primary-blue h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <div id="progress-message" class="text-sm text-gray-600 mt-2 font-body"></div>
                        </div>

                        <!-- ScamGuard Analysis Stream -->
                        <div id="scamguard-stream" class="hidden mb-4 animate-fadeIn">
                            <h2 class="text-xl font-bold text-gray-800 mb-3 font-heading">AI Security Analysis</h2>
                            <div id="scamguard-text" class="text-sm text-gray-700 markdown-content font-body"></div>
                        </div>

                        <!-- Detailed Results (appears at the end) -->
                        <div id="results"></div>
                    </div>
                </div>

                <!-- Left Column (2/3 width) - Advanced Tab -->
                <div id="results-advanced" class="tab-content hidden lg:col-span-2 bg-white rounded-lg shadow-md min-h-[500px] min-w-[52rem]">
                    <div class="p-6">
                        <!-- Deep Check Progress indicator (inside Advanced tab) -->
                        <div id="deep-check-progress" class="mb-6 hidden">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm font-semibold text-gray-700 font-body">Deep Analysis Progress</div>
                                <div class="flex flex-wrap gap-2">
                                    <span id="stage-parsing" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">Parsing</span>
                                    <span id="stage-technologies" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">Technologies</span>
                                    <span id="stage-trackers" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">Trackers</span>
                                    <span id="stage-scripts" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">Scripts</span>
                                    <span id="stage-security" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">Security</span>
                                </div>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="deep-check-bar" class="bg-primary-blue h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <div id="deep-check-status" class="text-sm text-gray-600 mt-2 font-body">Initializing...</div>
                        </div>

                        <!-- Results sections -->
                        <div id="deep-check-results" class="space-y-6">

                            <!-- Outgoing Links Section -->
                            <div id="section-links" class="hidden">
                                <h3 class="text-lg font-bold mb-3 font-heading">Outgoing Links</h3>
                                <div id="links-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
                                <div id="links-count" class="text-xs text-gray-500 mt-2 font-body"></div>
                            </div>

                            <!-- Images Section -->
                            <div id="section-images" class="hidden">
                                <h3 class="text-lg font-bold mb-3 font-heading">Images</h3>
                                <div id="images-list" class="grid grid-cols-2 gap-3 max-h-64 overflow-y-auto"></div>
                                <div id="images-count" class="text-xs text-gray-500 mt-2 font-body"></div>
                            </div>

                            <!-- Network Requests Section -->
                            <div id="section-requests" class="hidden">
                                <h3 class="text-lg font-bold mb-3 font-heading">Network Requests</h3>
                                <div id="requests-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
                                <div id="requests-count" class="text-xs text-gray-500 mt-2 font-body"></div>
                            </div>

                            <!-- Trackers Section -->
                            <div id="section-trackers" class="hidden">
                                <h3 class="text-lg font-bold mb-3 font-heading">Trackers & Analytics</h3>
                                <div id="trackers-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
                                <div id="trackers-count" class="text-xs text-gray-500 mt-2 font-body"></div>
                            </div>

                            <!-- Technologies Section -->
                            <div id="section-technologies" class="hidden">
                                <h3 class="text-lg font-bold mb-3 font-heading">Technologies</h3>
                                <div id="technologies-list" class="flex flex-wrap gap-2"></div>
                                <div id="technologies-count" class="text-xs text-gray-500 mt-2 font-body"></div>
                            </div>

                            <!-- Security Report Section -->
                            <div id="section-security" class="hidden">
                                <h3 class="text-lg font-bold mb-3 font-heading">Security Report</h3>
                                <div id="security-score" class="mb-4"></div>
                                <div id="security-issues" class="space-y-3">
                                    <div id="issues-critical" class="hidden">
                                        <h4 class="text-sm font-semibold text-red-600 mb-2 font-body">Critical</h4>
                                        <div id="critical-list" class="space-y-2"></div>
                                    </div>
                                    <div id="issues-high" class="hidden">
                                        <h4 class="text-sm font-semibold text-orange-600 mb-2 font-body">High</h4>
                                        <div id="high-list" class="space-y-2"></div>
                                    </div>
                                    <div id="issues-medium" class="hidden">
                                        <h4 class="text-sm font-semibold text-yellow-600 mb-2 font-body">Medium</h4>
                                        <div id="medium-list" class="space-y-2"></div>
                                    </div>
                                    <div id="issues-low" class="hidden">
                                        <h4 class="text-sm font-semibold text-blue-600 mb-2 font-body">Low</h4>
                                        <div id="low-list" class="space-y-2"></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            <!-- Right Column (1/3 width) -->
            <div class="lg:col-span-1 min-w-[27rem]">
                <div class="verdict-gauge text-center bg-white rounded-lg shadow-md p-4 mb-4 animate-fadeIn">
                    <div style="position: relative; width: 300px; height: 160px; margin: 0 auto;">
                        <svg width="300" height="160" viewBox="0 0 300 160">
                            <!-- Background track -->
                            <path d="M 40 140 A 110 110 0 0 1 260 140"
                                fill="none"
                                stroke="#f0f0f0"
                                stroke-width="16"
                                stroke-linecap="round"/>
                            
                            <!-- Red segment (0-50%) -->
                            <path id="red-segment"
                                d="M 40 140 A 110 110 0 0 1 260 140"
                                fill="none"
                                stroke="#FFB3C6"
                                stroke-width="16"
                                stroke-linecap="round"
                                stroke-dasharray="172.8 345.6"
                                stroke-dashoffset="0"/>
                            
                            <!-- Yellow segment (50-70%) -->
                            <path id="yellow-segment"
                                d="M 40 140 A 110 110 0 0 1 260 140"
                                fill="none"
                                stroke="#FFF2CC"
                                stroke-width="16"
                                stroke-linecap="round"
                                stroke-dasharray="69.1 345.6"
                                stroke-dashoffset="-172.8"/>
                            
                            <!-- Light Green segment (70-90%) -->
                            <path id="light-green-segment"
                                d="M 40 140 A 110 110 0 0 1 260 140"
                                fill="none"
                                stroke="#C8E6C9"
                                stroke-width="16"
                                stroke-linecap="round"
                                stroke-dasharray="69.1 345.6"
                                stroke-dashoffset="-241.9"/>
                            
                            <!-- Bright Green segment (90-100%) -->
                            <path id="bright-green-segment"
                                d="M 40 140 A 110 110 0 0 1 260 140"
                                fill="none"
                                stroke="#A5D6A7"
                                stroke-width="16"
                                stroke-linecap="round"
                                stroke-dasharray="34.6 345.6"
                                stroke-dashoffset="-311"/>
                            
                            <!-- Score indicator dot -->
                            <circle class="verdict-indicator" 
                                cx="40" 
                                cy="140" 
                                r="12" 
                                fill="white" 
                                stroke="#FF6B9D" 
                                stroke-width="4"/>
                        </svg>
                    </div>

                    <div class="mt-2">
                        <div class="verdict-status text-2xl font-bold text-gray-800" style="margin-top: -40px;">loading...</div>
                        <div class="verdict-text text-xs text-gray-600 mt-1">Analyzing URL safety...</div>
                    </div>
                </div>
                <!-- Screenshot Section -->
                <div id="screenshot-section" class="hidden bg-white rounded-lg shadow-md p-4 mb-4 animate-fadeIn">
                    <div class="relative rounded-lg overflow-hidden shadow-2xl" style="width: 100%; aspect-ratio: 16/10; padding: 5px; background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.98) 50%, rgba(255,255,255,1) 100%);">
                        <div class="relative w-full h-full rounded-md overflow-hidden bg-gray-100">
                            <!-- BlurHash Canvas (blurred placeholder) -->
                            <canvas
                                id="blurhash-canvas"
                                class="absolute inset-0 w-full h-full object-cover transition-opacity duration-500"
                                style="opacity: 0; filter: blur(20px);"
                            ></canvas>

                            <!-- Actual Screenshot Image (sharp) -->
                            <img
                                id="screenshot-img"
                                class="absolute inset-0 w-full h-full object-cover transition-opacity duration-500"
                                style="opacity: 0;"
                                alt="Page preview"
                            />

                            <!-- Gradient Overlay from bottom -->
                            <div class="absolute inset-x-0 bottom-0 h-24 pointer-events-none" style="background: linear-gradient(to top, rgba(0,0,0,0.05) 0%, transparent 100%);"></div>

                        
                            <!-- Loading Indicator -->
                            <div id="screenshot-loading"
                                 class="absolute inset-0 flex items-center justify-center bg-gray-100">
                                <div class="flex flex-col items-center">
                                    <svg class="animate-spin h-6 w-6 text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span class="mt-2 text-xs text-gray-600">Capturing...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            </div>
        </div>
    </header>

    <!-- Footer -->
    <div class="text-center text-gray-500 text-sm p-6 font-body">
        <p>Mwb Winter Hackathon 2025 - GO!</p>
    </div>

    <script>
        let eventSource = null;
        let scamGuardTextBuffer = ''; // Buffer for accumulating ScamGuard text
        let scamGuardVerdict = ''; // Store verdict separately to avoid duplication
        let timingData = {}; // Collect timing data as it arrives

        // Check if marked.js is loaded
        if (typeof marked === 'undefined') {
            console.error('marked.js library is not loaded!');
        }

        // Store current URL for screenshot functionality
        let currentAnalysisURL = '';
        let gaugeAnimationRunning = false; // Prevent multiple gauge animations

        // Function to handle URL analysis
        function handleURLSubmission(url) {
            if (!url) return;

            // Store URL for screenshot functionality
            currentAnalysisURL = url;

            // Get current tab from URL params or default to overview
            const urlParams = new URLSearchParams(window.location.search);
            const currentTab = urlParams.get('tab') || 'overview';

            console.log('=== handleURLSubmission ===');
            console.log('URL:', url);
            console.log('Current tab:', currentTab);

            // Update URL with query parameters
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('url', url);
            newUrl.searchParams.set('tab', currentTab);
            window.history.replaceState({}, '', newUrl.toString());
            console.log('URL updated to:', window.location.href);

            // Show results section below the form
            document.getElementById('results-section').classList.remove('hidden');

            // Restore tab state after results section is shown (if different from overview)
            if (currentTab === 'advanced') {
                switchTab('advanced', true); // true = skip initial deep check
            }

            // Clear previous results and hide sections
            document.getElementById('results').innerHTML = '';
            document.getElementById('screenshot-section').classList.add('hidden');
            timingData = {}; // Reset timing data

            // Show progress and loading
            document.getElementById('progress-container').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '10%';

            // Smooth scroll to progress bar
            setTimeout(() => {
                const progressContainer = document.getElementById('progress-container');
                const rect = progressContainer.getBoundingClientRect();
                const offset = window.pageYOffset + rect.top - 50; // Extra 50px scroll

                window.scrollTo({
                    top: offset,
                    behavior: 'smooth'
                });
            }, 100);

            // Reset all stages
            ['dns', 'tcp', 'tls', 'response', 'scamguard'].forEach(stage => {
                const el = document.getElementById('stage-' + stage);
                el.classList.remove('stage-complete', 'stage-active', 'stage-error');
            });

            // Reset and hide ScamGuard stream
            document.getElementById('scamguard-stream').classList.add('hidden');
            document.getElementById('scamguard-text').innerHTML = '';
            scamGuardTextBuffer = '';
            scamGuardVerdict = '';

            // Reset gauge animation state
            gaugeAnimationRunning = false;

            // Reset screenshot
            const canvas = document.getElementById('blurhash-canvas');
            const img = document.getElementById('screenshot-img');
            const loading = document.getElementById('screenshot-loading');
            if (canvas) {
                canvas.style.opacity = '0';
                canvas.classList.remove('screenshot-placeholder-hidden');
            }
            if (img) {
                img.src = '';
                img.style.opacity = '0';
                img.classList.remove('screenshot-loaded');
            }
            if (loading) {
                loading.style.display = 'flex';
                loading.innerHTML = '<svg class="animate-spin h-8 w-8 text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="ml-3 text-sm text-gray-600">Capturing screenshot...</span>';
            }

            // Close existing connection
            if (eventSource) {
                eventSource.close();
            }

            // Always reset deep check when new URL is submitted
            console.log('Resetting deep check for new URL:', url);

            // Reset deep check state to allow restart
            deepCheckRunning = false;

            // Cancel existing deep check request
            if (deepCheckAbortController) {
                console.log('Aborting previous deep check request');
                deepCheckAbortController.abort();
                deepCheckAbortController = null;
            }

            // Reset deep check data
            deepCheckData = {
                links: [], images: [], requests: [], trackers: [],
                technologies: [], securityIssues: { critical: [], high: [], medium: [], low: [] }
            };

            // Hide deep check progress
            document.getElementById('deep-check-progress').classList.add('hidden');

            // Reset stage badges
            ['parsing', 'technologies', 'trackers', 'scripts', 'security'].forEach(stage => {
                const el = document.getElementById('stage-' + stage);
                if (el) {
                    el.classList.remove('stage-complete', 'stage-active', 'stage-error');
                }
            });

            // Hide all sections
            ['links', 'images', 'requests', 'trackers', 'technologies', 'security'].forEach(section => {
                document.getElementById('section-' + section).classList.add('hidden');
            });

            // Clear all lists
            document.getElementById('links-list').innerHTML = '';
            document.getElementById('images-list').innerHTML = '';
            document.getElementById('requests-list').innerHTML = '';
            document.getElementById('trackers-list').innerHTML = '';
            document.getElementById('technologies-list').innerHTML = '';
            ['critical', 'high', 'medium', 'low'].forEach(severity => {
                document.getElementById(severity + '-list').innerHTML = '';
                document.getElementById('issues-' + severity).classList.add('hidden');
            });

            // Create EventSource for SSE
            const params = new URLSearchParams({ url: url });
            eventSource = new EventSource('/ui/stream?' + params.toString());

            // Continue with existing event source handlers...
            setupEventSourceHandlers();
        }

        // Handle initial form submission
        document.getElementById('check-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const url = this.querySelector('input[name="url"]').value;
            handleURLSubmission(url);
        });



        // Setup event source handlers
        function setupEventSourceHandlers() {
            // Handle different event types

            // Handle different event types
            eventSource.addEventListener('start', function(e) {
                document.getElementById('progress-message').textContent = 'Starting check...';
                document.getElementById('progress-bar').style.width = '10%';
            });

            eventSource.addEventListener('dns', function(e) {
                const data = JSON.parse(e.data);
                document.getElementById('stage-dns').classList.add('stage-complete');
                document.getElementById('progress-message').textContent = 'DNS resolved (' + data.data.dns_ms + 'ms)';
                document.getElementById('progress-bar').style.width = '30%';
                timingData.dns_ms = data.data.dns_ms; // Store DNS timing
            });

            eventSource.addEventListener('tcp', function(e) {
                const data = JSON.parse(e.data);
                document.getElementById('stage-tcp').classList.add('stage-complete');
                document.getElementById('progress-message').textContent = 'Connected (' + data.data.connect_ms + 'ms)';
                document.getElementById('progress-bar').style.width = '50%';
                timingData.connect_ms = data.data.connect_ms; // Store TCP timing
            });

            eventSource.addEventListener('tls', function(e) {
                const data = JSON.parse(e.data);
                document.getElementById('stage-tls').classList.add('stage-complete');
                document.getElementById('progress-message').textContent = 'TLS handshake complete (' + data.data.tls_ms + 'ms)';
                document.getElementById('progress-bar').style.width = '70%';
                timingData.tls_ms = data.data.tls_ms; // Store TLS timing
            });

            eventSource.addEventListener('response', function(e) {
                const data = JSON.parse(e.data);
                document.getElementById('stage-response').classList.add('stage-complete');
                document.getElementById('progress-message').textContent = 'Got response (status: ' + data.data.status + ')';
                document.getElementById('progress-bar').style.width = '90%';

                // Store TTFB timing
                if (data.data.ttfb_ms) {
                    timingData.ttfb_ms = data.data.ttfb_ms;
                }
                const totalMs = data.data.total_ms;

                // Trigger screenshot loading immediately after response
                document.getElementById('screenshot-section').classList.remove('hidden');
                loadScreenshot(currentAnalysisURL);
            });

            eventSource.addEventListener('redirect', function(e) {
                const data = JSON.parse(e.data);
                document.getElementById('progress-message').textContent = 'Following redirect (hop ' + data.data.hop + ')...';
            });

            // ScamGuard event handlers
            eventSource.addEventListener('scamguard.started', function(e) {
                document.getElementById('stage-scamguard').classList.add('stage-active');
                document.getElementById('scamguard-stream').classList.remove('hidden');
                scamGuardTextBuffer = 'Starting AI analysis...';
                const textEl = document.getElementById('scamguard-text');
                textEl.innerHTML = (typeof marked !== 'undefined') ? marked.parse(scamGuardTextBuffer) : scamGuardTextBuffer;
            });

            eventSource.addEventListener('scamguard.scanning', function(e) {
                scamGuardTextBuffer = 'Analyzing URL for security threats...';
                const textEl = document.getElementById('scamguard-text');
                textEl.innerHTML = (typeof marked !== 'undefined') ? marked.parse(scamGuardTextBuffer) : scamGuardTextBuffer;
            });

            eventSource.addEventListener('scamguard.verdict', function(e) {
                const data = JSON.parse(e.data);
                if (data.data && data.data.verdict) {
                    const verdict = data.data.verdict;

                    // Store the verdict globally for the gauge
                    window.currentVerdict = verdict;

                    switch(verdict) {
                        case 'safe':
                            scamGuardVerdict = '**✓ Verdict: Safe**';
                            break;
                        case 'malicious':
                            scamGuardVerdict = '**⚠ Verdict: Malicious**';
                            break;
                        case 'suspicious':
                            scamGuardVerdict = '**⚠ Verdict: Suspicious**';
                            break;
                        default:
                            scamGuardVerdict = '**Verdict: ' + verdict + '**';
                    }
                    // Don't add verdict to buffer yet - it will be added when displaying

                    // Store verdict but don't animate yet - wait for completion
                    console.log('Verdict received:', verdict, '- waiting for completion to animate');
                }
            });

            eventSource.addEventListener('scamguard.text', function(e) {
                const data = JSON.parse(e.data);
                if (data.data && data.data.text) {
                    // Append text delta to the buffer
                    scamGuardTextBuffer += data.data.text;

                    // Check if the text already contains the verdict to avoid duplication
                    const hasVerdictInText = scamGuardTextBuffer.includes('Verdict:');

                    // Render markdown with verdict at the top (if we have it and it's not already in the text)
                    const textEl = document.getElementById('scamguard-text');
                    const fullText = (scamGuardVerdict && !hasVerdictInText) ?
                        scamGuardVerdict + '\n\n' + scamGuardTextBuffer :
                        scamGuardTextBuffer;

                    if (typeof marked !== 'undefined') {
                        textEl.innerHTML = marked.parse(fullText);
                    } else {
                        // Fallback: convert newlines to <br> tags
                        textEl.innerHTML = fullText.replace(/\n/g, '<br>');
                    }

                    // Auto-scroll to bottom
                    const streamEl = document.getElementById('scamguard-stream');
                    streamEl.scrollTop = streamEl.scrollHeight;
                }
            });

            eventSource.addEventListener('scamguard.completed', function(e) {
                document.getElementById('stage-scamguard').classList.remove('stage-active');
                document.getElementById('stage-scamguard').classList.add('stage-complete');
            });

            eventSource.addEventListener('scamguard.error', function(e) {
                const data = JSON.parse(e.data);
                document.getElementById('stage-scamguard').classList.remove('stage-active');
                document.getElementById('stage-scamguard').classList.add('stage-error');

                const errorMsg = data.data && data.data.error ? data.data.error : 'Analysis failed';
                scamGuardTextBuffer = '⚠ ' + errorMsg;
                const textEl = document.getElementById('scamguard-text');
                textEl.innerHTML = (typeof marked !== 'undefined') ? marked.parse(scamGuardTextBuffer) : scamGuardTextBuffer;
            });

            eventSource.addEventListener('malicious', function(e) {
                // The data contains JSON-encoded HTML - parse it
                try {
                    console.log('Malicious event received:', e.data);
                    const html = JSON.parse(e.data);

                    // Check if html is a string (rendered template) or object (raw data)
                    if (typeof html === 'string') {
                        // It's the rendered HTML template
                        document.getElementById('results').innerHTML = html;

                        // Update verdict gauge directly for malicious URLs
                        setTimeout(function() {
                            const indicator = document.querySelector('.verdict-indicator');
                            const statusEl = document.querySelector('.verdict-status');
                            const textEl = document.querySelector('.verdict-text');

                            // Let updateVerdictGauge handle the positioning
                            if (typeof window.updateVerdictGauge === 'function') {
                                window.updateVerdictGauge('malicious');
                            }
                        }, 100);
                    } else if (typeof html === 'object') {
                        // It's raw JSON data - show error message
                        console.error('Received JSON object instead of HTML template:', html);
                        document.getElementById('results').innerHTML = `
                            <div class="bg-red-50 border border-red-200 rounded-md p-4">
                                <div class="flex items-start">
                                    <span class="text-red-600 text-xl mr-2">⚠</span>
                                    <div>
                                        <div class="text-sm font-semibold text-red-800">URL Flagged as Malicious</div>
                                        <div class="text-sm text-red-700 mt-1">${html.error_message || 'This URL was flagged as potentially malicious'}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    // Update verdict gauge if it exists
                    setTimeout(function() {
                        if (typeof window.updateVerdictGauge === 'function') {
                            window.updateVerdictGauge('bad');
                        }
                    }, 100);
                } catch (err) {
                    console.error('Failed to parse malicious event:', err, 'Raw data:', e.data);
                    document.getElementById('results').innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-md p-4">
                            <div class="flex items-start">
                                <span class="text-red-600 text-xl mr-2">⚠</span>
                                <div>
                                    <div class="text-sm font-semibold text-red-800">URL Flagged as Malicious</div>
                                    <div class="text-sm text-red-700 mt-1">This URL was flagged as potentially malicious</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Update UI to show malicious warning
                document.getElementById('progress-bar').style.width = '100%';
                document.getElementById('progress-bar').style.backgroundColor = '#ef4444';
                document.getElementById('progress-message').textContent = 'URL flagged as malicious!';

              

                // Keep progress container visible after malicious warning
                document.getElementById('progress-bar').style.backgroundColor = '';

                // Close the connection
                eventSource.close();
                eventSource = null;
            });

            eventSource.addEventListener('complete', function(e) {
                // Check if we should start deep check after basic check completes
                const urlParams = new URLSearchParams(window.location.search);
                const currentTab = urlParams.get('tab');

                if (currentTab === 'advanced' && currentAnalysisURL && !deepCheckRunning) {
                    console.log('Basic check complete, starting deep check for advanced tab');
                    setTimeout(() => startDeepCheck(currentAnalysisURL), 500);
                }
                // Parse the complete event data
                try {
                    console.log('Complete event received:', e.data);
                    const data = JSON.parse(e.data);

                    // Check if data is a string (rendered template) or object (raw data)
                    if (typeof data === 'string') {
                        // It's the rendered HTML template - display it
                        document.getElementById('results').innerHTML = data;

                        // Extract verdict from the HTML - look for the verdict assignment in the script
                        let verdictMatch = data.match(/verdict = '(\w+)'/);
                        let detectedVerdict = 'safe'; // default for successful checks

                        if (verdictMatch && verdictMatch[1]) {
                            detectedVerdict = verdictMatch[1];
                        }

                        // Also check if ScamGuard verdict is available
                        if (window.currentVerdict) {
                            detectedVerdict = window.currentVerdict;
                        }

                        console.log('Detected verdict from HTML:', detectedVerdict);

                        // Now manually run the verdict update since scripts don't execute from innerHTML
                        setTimeout(function() {
                            // Find and update the verdict elements directly
                            const indicator = document.querySelector('.verdict-indicator');
                            const statusEl = document.querySelector('.verdict-status');
                            const textEl = document.querySelector('.verdict-text');

                            if (indicator && statusEl && textEl) {
                                let x, y, statusText, descText;

                                switch(detectedVerdict) {
                                    case 'bad':
                                        x = 20; y = 100;
                                        statusText = 'bad';
                                        descText = "If you already entered in this website, don't take a risk.";
                                        break;
                                    case 'safe':
                                        x = 180; y = 100;
                                        statusText = 'safe';
                                        descText = 'No threats detected, this link appears safe.';
                                        break;
                                    default:
                                        x = 100; y = 20;
                                        statusText = 'uncertain';
                                        descText = "Something doesn't look right, proceed carefully.";
                                        break;
                                }

                                // Use updateVerdictGauge instead of manual positioning
                                if (typeof window.updateVerdictGauge === 'function') {
                                    window.updateVerdictGauge(detectedVerdict);
                                }
                            }
                        }, 100);

                        // Mark AI stage as complete and overall progress as complete
                        document.getElementById('stage-scamguard').classList.remove('stage-active');
                        document.getElementById('stage-scamguard').classList.add('stage-complete');
                        document.getElementById('progress-bar').style.width = '100%';
                        document.getElementById('progress-message').innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mr-2"><path d="M21.8011 10C22.2578 12.2413 21.9323 14.5714 20.879 16.6018C19.8256 18.6322 18.108 20.2401 16.0126 21.1573C13.9172 22.0746 11.5707 22.2458 9.3644 21.6424C7.15807 21.039 5.22529 19.6974 3.88838 17.8414C2.55146 15.9854 1.89122 13.7272 2.01776 11.4434C2.14431 9.15954 3.04998 6.98809 4.58375 5.29117C6.11752 3.59425 8.18668 2.47443 10.4462 2.11845C12.7056 1.76248 15.0189 2.19186 17.0001 3.335" stroke="#1FD555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 11L12 14L22 4" stroke="#1FD555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>Check complete!';

                        // NOW animate the gauge - everything is complete
                        setTimeout(function() {
                            if (typeof window.updateVerdictGauge === 'function' && detectedVerdict) {
                                console.log('Analysis complete - animating gauge with verdict:', detectedVerdict);
                                window.updateVerdictGauge(detectedVerdict);
                            }
                        }, 200);

                        // Keep progress container visible after completion

                        // Close the connection
                        eventSource.close();
                        eventSource = null;
                        return;
                    }

                    // Otherwise handle as raw JSON data (legacy path)
                    console.log('Complete event data (legacy JSON):', data); // Debug log

                    // Update verdict gauge with the final verdict if available (legacy path)
                    setTimeout(function() {
                        if (typeof window.updateVerdictGauge === 'function') {
                            // Use stored verdict from scamguard or default to unknown
                            const finalVerdict = window.currentVerdict || 'unknown';
                            console.log('Legacy path - animating gauge with verdict:', finalVerdict);
                            window.updateVerdictGauge(finalVerdict);
                        }
                    }, 100);

                    // Removed TLS and Details sections code as requested

                } catch (err) {
                    console.error('Failed to parse complete event data:', err);
                }

                // Mark AI stage as complete and overall progress as complete
                document.getElementById('stage-scamguard').classList.remove('stage-active');
                document.getElementById('stage-scamguard').classList.add('stage-complete');
                document.getElementById('progress-bar').style.width = '100%';
                document.getElementById('progress-message').innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline mr-2"><path d="M21.8011 10C22.2578 12.2413 21.9323 14.5714 20.879 16.6018C19.8256 18.6322 18.108 20.2401 16.0126 21.1573C13.9172 22.0746 11.5707 22.2458 9.3644 21.6424C7.15807 21.039 5.22529 19.6974 3.88838 17.8414C2.55146 15.9854 1.89122 13.7272 2.01776 11.4434C2.14431 9.15954 3.04998 6.98809 4.58375 5.29117C6.11752 3.59425 8.18668 2.47443 10.4462 2.11845C12.7056 1.76248 15.0189 2.19186 17.0001 3.335" stroke="#1FD555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 11L12 14L22 4" stroke="#1FD555" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>Check complete!';
                // Keep progress container visible after completion

                // Close the connection
                eventSource.close();
                eventSource = null;
            });

            eventSource.addEventListener('error', function(e) {
                // Show error in the results section
                let errorMessage = 'Check failed';
                try {
                    const errorData = JSON.parse(e.data);
                    if (errorData.message) {
                        errorMessage = errorData.message;
                    } else if (typeof errorData === 'string') {
                        // If it's HTML, show it in results
                        document.getElementById('results').innerHTML = errorData;
                    }
                } catch (err) {
                    // Default error message
                }

                document.getElementById('progress-message').textContent = 'Error: ' + errorMessage;
                document.getElementById('progress-bar').style.backgroundColor = '#ef4444';

                // Keep progress container visible after error
                document.getElementById('progress-bar').style.backgroundColor = '';

                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            });

            // Handle connection errors
            eventSource.onerror = function(e) {
                console.error('EventSource connection error');
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            };
        }

        // Screenshot Loading Function
        function loadScreenshot(url) {
            const canvas = document.getElementById('blurhash-canvas');
            const img = document.getElementById('screenshot-img');
            const loading = document.getElementById('screenshot-loading');
            const info = document.getElementById('screenshot-info');

            if (!canvas || !img) return;

            // Keep loading state visible
            if (loading) {
                loading.style.display = 'flex';
                loading.innerHTML = '<svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="ml-3 text-sm text-gray-600">Capturing screenshot...</span>';
            }

            // Fetch screenshot with retry logic
            let retryCount = 0;
            const maxRetries = 3;

            function attemptScreenshot() {
                fetch('/screenshot', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url: url, response_type: 'base64'})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.base64_data) {
                        // Step 1: Decode and render blurhash if available
                        if (data.blurhash && data.width && data.height && typeof BlurHash !== 'undefined') {
                            try {
                                const pixels = BlurHash.decode(data.blurhash, 32, 32);
                                canvas.width = 32;
                                canvas.height = 32;
                                const ctx = canvas.getContext('2d');
                                const imageData = ctx.createImageData(32, 32);
                                imageData.data.set(pixels);
                                ctx.putImageData(imageData, 0, 0);
                                canvas.style.opacity = '1';
                                // Hide loading once we have blurhash
                                if (loading) loading.style.display = 'none';
                            } catch (err) {
                                console.error('Failed to decode blurhash:', err);
                            }
                        }

                        // Step 2: Load full screenshot image
                        const newImg = new Image();
                        newImg.onload = function() {
                            img.src = data.base64_data;
                            if (loading) loading.style.display = 'none';

                            // Capture time removed - no longer displayed

                            // Fade in sharp image, fade out blur
                            setTimeout(() => {
                                img.classList.add('screenshot-loaded');
                                canvas.classList.add('screenshot-placeholder-hidden');
                            }, 50);
                        };

                        newImg.onerror = function() {
                            // Only show error after retries exhausted
                            if (retryCount >= maxRetries && loading) {
                                loading.innerHTML = '<span class="text-gray-400 text-sm">Screenshot preview not available</span>';
                            }
                        };

                        newImg.src = data.base64_data;
                    } else {
                        // Retry if not successful yet
                        retryCount++;
                        if (retryCount < maxRetries) {
                            setTimeout(attemptScreenshot, 2000); // Retry after 2 seconds
                        } else if (loading) {
                            // Only show error message after all retries
                            loading.innerHTML = '<span class="text-gray-400 text-sm">Screenshot preview not available</span>';
                        }
                    }
                })
                .catch(err => {
                    console.error('Failed to fetch screenshot:', err);
                    retryCount++;
                    if (retryCount < maxRetries) {
                        setTimeout(attemptScreenshot, 2000); // Retry after 2 seconds
                    } else if (loading) {
                        loading.innerHTML = '<span class="text-gray-400 text-sm">Screenshot preview not available</span>';
                    }
                });
            }

            // Start the first attempt
            attemptScreenshot();
        }

        // Update the new gauge based on verdict
        function updateVerdictGauge(verdict) {
            // Prevent multiple animations from running
            if (gaugeAnimationRunning) {
                console.log('Gauge animation already running, skipping...');
                return;
            }
            
            gaugeAnimationRunning = true;
            
            let targetScore = 0;
            let activeColor = '#FF6B9D';
            let statusText = 'loading...';
            let descText = 'Analyzing URL safety...';

            // Convert verdict to score and determine active segment
            switch(verdict) {
                case 'bad':
                case 'malicious':
                    targetScore = 25; // Red segment
                    activeColor = '#FF6B9D';
                    statusText = 'Dangerous';
                    descText = "If you already entered this website, don't take a risk.";
                    break;
                case 'suspicious':
                    targetScore = 60; // Yellow segment  
                    activeColor = '#FFD93D';
                    statusText = 'Suspicious';
                    descText = "Something doesn't look right, proceed carefully.";
                    break;
                case 'safe':
                    targetScore = 95; // Bright green segment
                    activeColor = '#22c55e';
                    statusText = 'Safe';
                    descText = 'No threats detected, this link appears safe.';
                    break;
                default:
                    targetScore = 75; // Light green segment
                    activeColor = '#6BCF7F';
                    statusText = 'Unknown';
                    descText = 'Unable to determine safety level.';
                    break;
            }

            console.log('Starting gauge animation - Verdict:', verdict, 'Target Score:', targetScore, 'Color:', activeColor);

            // Update segment colors
            const redSeg = document.getElementById('red-segment');
            const yellowSeg = document.getElementById('yellow-segment');
            const lightGreenSeg = document.getElementById('light-green-segment');
            const brightGreenSeg = document.getElementById('bright-green-segment');

            if (redSeg && yellowSeg && lightGreenSeg && brightGreenSeg) {
                // Reset all segments to inactive colors
                redSeg.setAttribute('stroke', '#FF1744');
                yellowSeg.setAttribute('stroke', '#FFC107');
                lightGreenSeg.setAttribute('stroke', '#4CAF50');
                brightGreenSeg.setAttribute('stroke', '#2E7D32');

                // Activate the appropriate segment
                if (targetScore < 50) {
                    redSeg.setAttribute('stroke', '#FF1744');
                } else if (targetScore < 70) {
                    yellowSeg.setAttribute('stroke', '#FFC107');
                } else if (targetScore < 90) {
                    lightGreenSeg.setAttribute('stroke', '#4CAF50');
                } else {
                    brightGreenSeg.setAttribute('stroke', '#2E7D32');
                }
            }

            // Animate indicator from 0 to target score
            const indicator = document.querySelector('.verdict-indicator');
            const statusEl = document.querySelector('.verdict-status');
            const textEl = document.querySelector('.verdict-text');
            
            if (!indicator) {
                console.error('Could not find verdict-indicator element');
                gaugeAnimationRunning = false; // Reset flag on error
                return;
            }

            // Animation parameters
            const animationDuration = 2000; // 2 seconds
            const startTime = performance.now();
            const radius = 110;

            function animateIndicator(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / animationDuration, 1);
                
                // Use easeOutCubic for smooth animation
                const easeOutCubic = 1 - Math.pow(1 - progress, 3);
                const currentScore = easeOutCubic * targetScore;
                
                // Calculate indicator position
                const angle = Math.PI - (currentScore / 100 * Math.PI);
                const cx = 150 + radius * Math.cos(angle);
                const cy = 140 - radius * Math.sin(angle);
                
                // Update indicator position and color
                indicator.setAttribute('cx', cx.toString());
                indicator.setAttribute('cy', cy.toString());
                indicator.setAttribute('stroke', activeColor);
                
                // Update status text with animated score
                if (statusEl && progress > 0.5) { // Show text after halfway through animation
                    statusEl.textContent = statusText;
                }
                if (textEl && progress > 0.7) { // Show description after 70% of animation
                    textEl.textContent = descText;
                }
                
                // Continue animation or finish
                if (progress < 1) {
                    requestAnimationFrame(animateIndicator);
                } else {
                    console.log('Animation complete - Final position:', cx, cy);
                    gaugeAnimationRunning = false; // Reset flag when animation completes
                }
            }
            
            // Start the animation
            requestAnimationFrame(animateIndicator);
        }

        // Make updateVerdictGauge available globally
        window.updateVerdictGauge = updateVerdictGauge;


        // Tab switching functionality
        function switchTab(tabName, skipDeepCheck = false) {
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Activate the selected tab button
            document.getElementById('tab-' + tabName).classList.add('active');

            // Show the selected tab content
            document.getElementById('results-' + tabName).classList.remove('hidden');

            // Update URL query parameters
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('tab', tabName);
            if (currentAnalysisURL) {
                newUrl.searchParams.set('url', currentAnalysisURL);
            }
            window.history.replaceState({}, '', newUrl.toString());

            // Start deep check if switching to advanced tab
            if (tabName === 'advanced' && currentAnalysisURL && !skipDeepCheck && !deepCheckRunning) {
                console.log('Tab switched to advanced, starting deep check for:', currentAnalysisURL);
                setTimeout(() => startDeepCheck(currentAnalysisURL), 100);
            }
        }

        // Add event listeners to tab buttons
        document.getElementById('tab-overview').addEventListener('click', () => switchTab('overview'));
        document.getElementById('tab-advanced').addEventListener('click', () => switchTab('advanced'));

        // Deep Check Streaming
        let deepCheckAbortController = null; // Changed from deepCheckEventSource
        let deepCheckRunning = false;

        // Track data for each section
        let deepCheckData = {
            links: [],
            images: [],
            requests: [],
            trackers: [],
            technologies: [],
            securityIssues: { critical: [], high: [], medium: [], low: [] }
        };

        function startDeepCheck(url) {
            console.log('=== startDeepCheck called ===');
            console.log('URL:', url);
            console.log('deepCheckRunning:', deepCheckRunning);

            if (deepCheckRunning || !url) {
                console.log('Returning early - deepCheckRunning:', deepCheckRunning, 'url:', url);
                return;
            }

            console.log('Starting deep check...');
            deepCheckRunning = true;

            // Reset data
            deepCheckData = {
                links: [], images: [], requests: [], trackers: [],
                technologies: [], securityIssues: { critical: [], high: [], medium: [], low: [] }
            };

            // Show progress
            document.getElementById('deep-check-progress').classList.remove('hidden');
            document.getElementById('deep-check-bar').style.width = '0%';
            document.getElementById('deep-check-status').textContent = 'Initializing...';

            // Reset stage badges
            ['parsing', 'technologies', 'trackers', 'scripts', 'security'].forEach(stage => {
                const el = document.getElementById('stage-' + stage);
                if (el) {
                    el.classList.remove('stage-complete', 'stage-active', 'stage-error');
                }
            });

            // Hide all sections initially
            ['links', 'images', 'requests', 'trackers', 'technologies', 'security'].forEach(section => {
                document.getElementById('section-' + section).classList.add('hidden');
            });

            // Clear all lists
            document.getElementById('links-list').innerHTML = '';
            document.getElementById('images-list').innerHTML = '';
            document.getElementById('requests-list').innerHTML = '';
            document.getElementById('trackers-list').innerHTML = '';
            document.getElementById('technologies-list').innerHTML = '';
            ['critical', 'high', 'medium', 'low'].forEach(severity => {
                document.getElementById(severity + '-list').innerHTML = '';
                document.getElementById('issues-' + severity).classList.add('hidden');
            });

            // Cancel any existing connection
            if (deepCheckAbortController) {
                console.log('Aborting existing deep check');
                deepCheckAbortController.abort();
            }

            // Create new AbortController for this request
            deepCheckAbortController = new AbortController();

            // Create new EventSource for deep-check endpoint
            const params = new URLSearchParams({ url: url });
            // Use fetch with ReadableStream to handle SSE
            fetch('/deep-check?' + params.toString(), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream'
                },
                body: JSON.stringify({ url: url }),
                signal: deepCheckAbortController.signal // Add abort signal
            }).then(response => {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let currentEvent = '';

                function processStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            console.log('Deep check stream completed');
                            deepCheckRunning = false;
                            deepCheckAbortController = null; // Clear controller on completion
                            return;
                        }

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || ''; // Keep incomplete line in buffer

                        for (const line of lines) {
                            if (line.startsWith('event:')) {
                                currentEvent = line.substring(6).trim();
                            }
                            else if (line.startsWith('data:')) {
                                const eventData = line.substring(5).trim();
                                if (eventData && currentEvent) {
                                    try {
                                        const data = JSON.parse(eventData);
                                        // Create event object with stage and data
                                        handleDeepCheckEvent({
                                            stage: currentEvent,
                                            data: data
                                        });
                                        currentEvent = ''; // Reset after handling
                                    } catch (e) {
                                        console.error('Failed to parse SSE data:', e, 'Event:', currentEvent, 'Data:', eventData);
                                    }
                                }
                            }
                        }

                        processStream();
                    }).catch(err => {
                        // Check if it was aborted (not an error)
                        if (err.name === 'AbortError') {
                            console.log('Stream aborted (new URL entered)');
                        } else {
                            console.error('Stream error:', err);
                        }
                        deepCheckRunning = false;
                    });
                }

                processStream();
            }).catch(err => {
                // Check if it was aborted (not an error)
                if (err.name === 'AbortError') {
                    console.log('Deep check was aborted (new URL entered)');
                } else {
                    console.error('Failed to start deep check:', err);
                    document.getElementById('deep-check-status').textContent = 'Failed to start analysis';
                }
                deepCheckRunning = false;
            });
        }

        function handleDeepCheckEvent(data) {
            if (!data) return;

            console.log('Deep check event:', data.stage, data.data);

            // Handle different event types
            if (data.stage === 'analysis_progress' && data.data) {
                const progress = data.data.progress || 0;
                const step = data.data.step || '';
                document.getElementById('deep-check-bar').style.width = progress + '%';
                if (step) {
                    document.getElementById('deep-check-status').textContent = step;
                }

                // Update stage badges based on progress
                if (progress >= 20) {
                    // Parsing stage complete
                    const parseEl = document.getElementById('stage-parsing');
                    if (parseEl && !parseEl.classList.contains('stage-complete')) {
                        parseEl.classList.add('stage-complete');
                    }
                }
                if (progress >= 30 && progress < 40) {
                    // Technologies stage active
                    const techEl = document.getElementById('stage-technologies');
                    if (techEl) {
                        techEl.classList.add('stage-active');
                    }
                }
                if (progress >= 40) {
                    // Technologies complete
                    const techEl = document.getElementById('stage-technologies');
                    if (techEl) {
                        techEl.classList.remove('stage-active');
                        techEl.classList.add('stage-complete');
                    }
                }
                if (progress >= 40 && progress < 50) {
                    // Trackers stage active
                    const trackerEl = document.getElementById('stage-trackers');
                    if (trackerEl) {
                        trackerEl.classList.add('stage-active');
                    }
                }
                if (progress >= 50) {
                    // Trackers complete
                    const trackerEl = document.getElementById('stage-trackers');
                    if (trackerEl) {
                        trackerEl.classList.remove('stage-active');
                        trackerEl.classList.add('stage-complete');
                    }
                }
                if (progress >= 50 && progress < 70) {
                    // Scripts stage active
                    const scriptEl = document.getElementById('stage-scripts');
                    if (scriptEl) {
                        scriptEl.classList.add('stage-active');
                    }
                }
                if (progress >= 70) {
                    // Scripts complete
                    const scriptEl = document.getElementById('stage-scripts');
                    if (scriptEl) {
                        scriptEl.classList.remove('stage-active');
                        scriptEl.classList.add('stage-complete');
                    }
                }
                if (progress >= 70 && progress < 100) {
                    // Security stage active
                    const secEl = document.getElementById('stage-security');
                    if (secEl) {
                        secEl.classList.add('stage-active');
                    }
                }
                if (progress >= 100) {
                    // Security complete
                    const secEl = document.getElementById('stage-security');
                    if (secEl) {
                        secEl.classList.remove('stage-active');
                        secEl.classList.add('stage-complete');
                    }
                }
            }
            else if (data.stage === 'links_found' && data.data && data.data.links) {
                deepCheckData.links = data.data.links;
                renderLinks();
            }
            else if (data.stage === 'images_found' && data.data && data.data.images) {
                deepCheckData.images = data.data.images;
                renderImages();
            }
            else if (data.stage === 'requests_found' && data.data && data.data.requests) {
                deepCheckData.requests = data.data.requests;
                renderRequests();
            }
            else if (data.stage === 'tracker_found' && data.data) {
                deepCheckData.trackers.push(data.data);
                renderTrackers();
            }
            else if (data.stage === 'technology_found' && data.data) {
                deepCheckData.technologies.push(data.data);
                renderTechnologies();
            }
            else if (data.stage === 'security_issue_found' && data.data && data.data.security_issue) {
                const issue = data.data.security_issue;
                const severity = (issue.severity || 'low').toLowerCase();
                if (deepCheckData.securityIssues[severity]) {
                    deepCheckData.securityIssues[severity].push(issue);
                    renderSecurityIssues();
                }
            }
            else if (data.stage === 'security_score' && data.data) {
                renderSecurityScore(data.data);
            }
            else if (data.stage === 'analysis_complete') {
                deepCheckRunning = false;
                document.getElementById('deep-check-bar').style.width = '100%';
                document.getElementById('deep-check-status').textContent = 'Analysis complete';

                // Ensure all stage badges are marked complete and not active (fixes blinking)
                ['parsing', 'technologies', 'trackers', 'scripts', 'security'].forEach(stage => {
                    const el = document.getElementById('stage-' + stage);
                    if (el) {
                        el.classList.remove('stage-active'); // Remove pulsing animation
                        el.classList.add('stage-complete');
                    }
                });
            }
            else if (data.stage === 'error') {
                deepCheckRunning = false;
                const errorMsg = (data.data && data.data.error) || 'Analysis failed';
                document.getElementById('deep-check-status').textContent = errorMsg;
            }
        }

        function renderLinks() {
            const container = document.getElementById('links-list');
            const count = document.getElementById('links-count');
            const section = document.getElementById('section-links');

            if (deepCheckData.links.length === 0) return;

            // Only show first 50 links for performance
            const displayLinks = deepCheckData.links.slice(0, 50);

            container.innerHTML = displayLinks.map(link => `
                <div class="text-xs p-2 bg-gray-50 rounded hover:bg-gray-100">
                    <a href="${link.absolute_url || link.href}" target="_blank" class="text-primary-blue hover:underline truncate block">
                        ${link.text || link.href}
                    </a>
                    ${link.rel ? `<span class="text-gray-500 ml-2">(${link.rel})</span>` : ''}
                </div>
            `).join('');

            count.textContent = `${deepCheckData.links.length} links found${deepCheckData.links.length > 50 ? ' (showing first 50)' : ''}`;
            section.classList.remove('hidden');
        }

        function renderImages() {
            const container = document.getElementById('images-list');
            const count = document.getElementById('images-count');
            const section = document.getElementById('section-images');

            if (deepCheckData.images.length === 0) return;

            // Only show first 20 images
            const displayImages = deepCheckData.images.slice(0, 20);

            container.innerHTML = displayImages.map(img => `
                <div class="text-xs p-2 bg-gray-50 rounded">
                    <div class="font-medium truncate">${img.src}</div>
                    ${img.alt ? `<div class="text-gray-500">${img.alt}</div>` : '<div class="text-red-500">Missing alt text</div>'}
                    ${img.format ? `<div class="text-gray-400">${img.format}</div>` : ''}
                </div>
            `).join('');

            count.textContent = `${deepCheckData.images.length} images found${deepCheckData.images.length > 20 ? ' (showing first 20)' : ''}`;
            section.classList.remove('hidden');
        }

        function renderRequests() {
            const container = document.getElementById('requests-list');
            const count = document.getElementById('requests-count');
            const section = document.getElementById('section-requests');

            if (deepCheckData.requests.length === 0) return;

            // Only show first 50 requests
            const displayRequests = deepCheckData.requests.slice(0, 50);

            container.innerHTML = displayRequests.map(req => `
                <div class="text-xs p-2 bg-gray-50 rounded flex justify-between items-center">
                    <div class="truncate flex-1">
                        <span class="font-mono text-gray-600">${req.method || 'GET'}</span>
                        <span class="ml-2">${req.url}</span>
                    </div>
                    ${req.type ? `<span class="text-gray-500 text-xs ml-2">${req.type}</span>` : ''}
                </div>
            `).join('');

            count.textContent = `${deepCheckData.requests.length} requests found${deepCheckData.requests.length > 50 ? ' (showing first 50)' : ''}`;
            section.classList.remove('hidden');
        }

        function renderTrackers() {
            const container = document.getElementById('trackers-list');
            const count = document.getElementById('trackers-count');
            const section = document.getElementById('section-trackers');

            if (deepCheckData.trackers.length === 0) return;

            container.innerHTML = deepCheckData.trackers.map(tracker => `
                <div class="text-xs p-3 bg-yellow-50 border border-yellow-200 rounded">
                    <div class="font-semibold">${tracker.name || 'Unknown Tracker'}</div>
                    ${tracker.category ? `<div class="text-gray-600">${tracker.category}</div>` : ''}
                    ${tracker.privacy_risk ? `<div class="text-red-600 text-xs">Privacy Risk: ${tracker.privacy_risk}</div>` : ''}
                </div>
            `).join('');

            count.textContent = `${deepCheckData.trackers.length} trackers detected`;
            section.classList.remove('hidden');
        }

        function renderTechnologies() {
            const container = document.getElementById('technologies-list');
            const count = document.getElementById('technologies-count');
            const section = document.getElementById('section-technologies');

            if (deepCheckData.technologies.length === 0) return;

            container.innerHTML = deepCheckData.technologies.map(tech => `
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    ${tech.name || 'Unknown'}
                    ${tech.version ? ` v${tech.version}` : ''}
                </span>
            `).join('');

            count.textContent = `${deepCheckData.technologies.length} technologies detected`;
            section.classList.remove('hidden');
        }

        function renderSecurityScore(scoreData) {
            const scoreContainer = document.getElementById('security-score');
            const section = document.getElementById('section-security');

            const score = scoreData.score || 0;
            let scoreColor = 'text-green-600';
            let scoreLabel = 'Good';

            if (score < 50) {
                scoreColor = 'text-red-600';
                scoreLabel = 'Poor';
            } else if (score < 70) {
                scoreColor = 'text-orange-600';
                scoreLabel = 'Fair';
            }

            scoreContainer.innerHTML = `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded">
                    <div>
                        <div class="text-sm font-semibold font-body">Security Score</div>
                        <div class="text-xs text-gray-600 font-body">${scoreData.total_issues || 0} total issues</div>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold ${scoreColor}">${score}</div>
                        <div class="text-xs text-gray-600">${scoreLabel}</div>
                    </div>
                </div>
            `;

            section.classList.remove('hidden');
        }

        function renderSecurityIssues() {
            const section = document.getElementById('section-security');

            ['critical', 'high', 'medium', 'low'].forEach(severity => {
                const issues = deepCheckData.securityIssues[severity];
                if (issues && issues.length > 0) {
                    const container = document.getElementById(severity + '-list');
                    const issueSection = document.getElementById('issues-' + severity);

                    issueSection.classList.remove('hidden');
                    container.innerHTML = issues.map(issue => `
                        <div class="text-xs p-3 bg-white border border-gray-200 rounded">
                            <div class="font-semibold">${issue.title || issue.type}</div>
                            <div class="text-gray-600 mt-1">${issue.description || ''}</div>
                            ${issue.remediation ? `<div class="text-gray-500 mt-2 italic">Fix: ${issue.remediation}</div>` : ''}
                        </div>
                    `).join('');
                }
            });

            section.classList.remove('hidden');
        }

        // On page load, restore state from URL query parameters
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const url = urlParams.get('url');
            const tab = urlParams.get('tab');

            // If URL in query params, auto-submit
            if (url) {
                const input = document.querySelector('input[name="url"]');
                if (input) {
                    input.value = url;
                    // Auto-submit the form
                    handleURLSubmission(url);
                }
            }
        });

        // Handle browser back/forward navigation
        window.addEventListener('popstate', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const newUrl = urlParams.get('url');
            const newTab = urlParams.get('tab');

            // If URL changed, re-analyze
            if (newUrl && newUrl !== currentAnalysisURL) {
                const input = document.querySelector('input[name="url"]');
                if (input) {
                    input.value = newUrl;
                    handleURLSubmission(newUrl);
                }
            }
            // If just tab changed, switch tabs
            else if (newTab && document.getElementById('results-section') && !document.getElementById('results-section').classList.contains('hidden')) {
                switchTab(newTab, false); // false = allow deep check
            }
        });
    </script>
</body>
</html>
