<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blink URL Checker</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3csvg width='38' height='31' viewBox='0 0 38 31' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M32.0027 1.36379C30.6679 0.107605 30.4953 0 30.2403 0C30.1422 0 30.0218 0.0398185 29.9085 0.155956C29.7952 0.272093 19.3001 11.0392 19.3001 11.0392C19.2063 11.1331 19.0859 11.1866 18.9655 11.1866C18.8451 11.1866 18.7247 11.1331 18.6308 11.0392C18.6308 11.0392 8.13579 0.272093 8.02249 0.155956C7.9092 0.0398185 7.78832 0 7.69067 0C7.43564 0 7.26309 0.107605 5.92822 1.36379C3.48128 3.66568 0 9.19524 0 15.0253C0 16.6935 -0.00094754 26.1513 10.2623 30.8551C10.7311 31.0694 11.1928 30.5631 10.8245 30.1858C9.15922 28.4778 7.85231 25.3104 7.85231 22.5809C7.85231 20.2781 8.54867 18.1222 9.7399 16.328C9.91387 16.0199 10.1817 15.9663 10.4898 16.2744C10.4898 16.2744 18.4862 24.3637 18.6204 24.4993C18.7545 24.6354 18.8555 24.6557 18.965 24.6557C19.0745 24.6557 19.1755 24.6349 19.3096 24.4993C19.4438 24.3633 27.4402 16.2744 27.4402 16.2744C27.7483 15.9663 28.0161 16.0199 28.1901 16.328C29.3818 18.1222 30.0777 20.2776 30.0777 22.5809C30.0777 25.3109 28.7708 28.4778 27.1055 30.1858C26.7372 30.5636 27.1994 31.0694 27.6677 30.8551C37.931 26.1513 37.93 16.693 37.93 15.0253C37.93 9.19524 34.4487 3.66615 32.0023 1.36379H32.0027Z' fill='%230059FF'/%3e%3c/svg%3e">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3csvg width='38' height='31' viewBox='0 0 38 31' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M32.0027 1.36379C30.6679 0.107605 30.4953 0 30.2403 0C30.1422 0 30.0218 0.0398185 29.9085 0.155956C29.7952 0.272093 19.3001 11.0392 19.3001 11.0392C19.2063 11.1331 19.0859 11.1866 18.9655 11.1866C18.8451 11.1866 18.7247 11.1331 18.6308 11.0392C18.6308 11.0392 8.13579 0.272093 8.02249 0.155956C7.9092 0.0398185 7.78832 0 7.69067 0C7.43564 0 7.26309 0.107605 5.92822 1.36379C3.48128 3.66568 0 9.19524 0 15.0253C0 16.6935 -0.00094754 26.1513 10.2623 30.8551C10.7311 31.0694 11.1928 30.5631 10.8245 30.1858C9.15922 28.4778 7.85231 25.3104 7.85231 22.5809C7.85231 20.2781 8.54867 18.1222 9.7399 16.328C9.91387 16.0199 10.1817 15.9663 10.4898 16.2744C10.4898 16.2744 18.4862 24.3637 18.6204 24.4993C18.7545 24.6354 18.8555 24.6557 18.965 24.6557C19.0745 24.6557 19.1755 24.6349 19.3096 24.4993C19.4438 24.3633 27.4402 16.2744 27.4402 16.2744C27.7483 15.9663 28.0161 16.0199 28.1901 16.328C29.3818 18.1222 30.0777 20.2776 30.0777 22.5809C30.0777 25.3109 28.7708 28.4778 27.1055 30.1858C26.7372 30.5636 27.1994 31.0694 27.6677 30.8551C37.931 26.1513 37.93 16.693 37.93 15.0253C37.93 9.19524 34.4487 3.66615 32.0023 1.36379H32.0027Z' fill='%230059FF'/%3e%3c/svg%3e">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/blurhash@2.0.5/dist/blurhash.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'heading': ['PP Right Grotesk', 'system-ui', 'sans-serif'],
                        'body': ['Spline Sans', 'system-ui', 'sans-serif']
                    },
                    colors: {
                        'primary-blue': '#0059FF',
                        'dark-blue': '#001B4D',
                        'light-bg': '#D5EEFF'
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Font Imports */
        @font-face {
            font-family: 'PP Right Grotesk';
            src: url('https://www.malwarebytes.com/wp-content/themes/malwarebytes/assets/build/fonts/PPRightGrotesk-CompactDark.b5625601.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Spline Sans';
            src: url('https://www.malwarebytes.com/wp-content/themes/malwarebytes/assets/build/fonts/SplineSans-Regular.7b0c3511.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Spline Sans';
            src: url('https://www.malwarebytes.com/wp-content/themes/malwarebytes/assets/build/fonts/SplineSans-SemiBold.5c8398a6.woff2') format('woff2');
            font-weight: 600;
            font-style: normal;
            font-display: swap;
        }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .progress-stage {
            transition: all 0.3s ease;
            font-family: 'Spline Sans', system-ui, sans-serif;
        }

        .stage-active {
            animation: pulse-slow 2s ease-in-out infinite;
            background-color: #001B4D !important;
            color: white !important;
        }

        .stage-complete {
            background-color: #0059FF !important;
            color: white !important;
        }

        .stage-error {
            background-color: #ef4444 !important;
            color: white !important;
        }

        .progress-bar {
            transition: width 0.5s ease-in-out;
        }

        /* Markdown styling for ScamGuard analysis */
        .markdown-content {
            line-height: 1.6;
            font-family: 'Spline Sans', system-ui, sans-serif;
        }

        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            font-family: 'PP Right Grotesk', system-ui, sans-serif;
            font-weight: 700;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        .markdown-content h1 {
            font-size: 1.5em;
        }

        .markdown-content h2 {
            font-size: 1.3em;
        }

        .markdown-content h3 {
            font-size: 1.1em;
        }

        .markdown-content p {
            margin-bottom: 0.75em;
        }

        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5em;
            margin-bottom: 0.75em;
        }

        .markdown-content li {
            margin-bottom: 0.25em;
        }

        .markdown-content strong {
            font-weight: 600;
        }

        .markdown-content em {
            font-style: italic;
        }

        .markdown-content code {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.75em;
            border-radius: 5px;
            overflow-x: auto;
            margin-bottom: 0.75em;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .markdown-content blockquote {
            border-left: 3px solid #d1d5db;
            padding-left: 1em;
            margin-left: 0;
            color: #6b7280;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }

        /* Screenshot progressive loading styles */
        .screenshot-loaded {
            opacity: 1 !important;
        }

        .screenshot-placeholder-hidden {
            opacity: 0 !important;
        }
    </style>
</head>
<body class="min-h-screen font-body" style="background-color: #D5EEFF;">
    <!-- Initial Centered Form View -->
    <header id="initial-form" class="min-h-screen flex items-center justify-center p-6">
        <div class="w-full max-w-2xl">
            <!-- Centered Header -->
            <div class="text-center mb-16">
                <!-- Logo -->
                <div class="mb-8">
                    <svg width="76" height="62" viewBox="0 0 38 31" fill="none" xmlns="http://www.w3.org/2000/svg" class="mx-auto">
                        <path d="M32.0027 1.36379C30.6679 0.107605 30.4953 0 30.2403 0C30.1422 0 30.0218 0.0398185 29.9085 0.155956C29.7952 0.272093 19.3001 11.0392 19.3001 11.0392C19.2063 11.1331 19.0859 11.1866 18.9655 11.1866C18.8451 11.1866 18.7247 11.1331 18.6308 11.0392C18.6308 11.0392 8.13579 0.272093 8.02249 0.155956C7.9092 0.0398185 7.78832 0 7.69067 0C7.43564 0 7.26309 0.107605 5.92822 1.36379C3.48128 3.66568 0 9.19524 0 15.0253C0 16.6935 -0.00094754 26.1513 10.2623 30.8551C10.7311 31.0694 11.1928 30.5631 10.8245 30.1858C9.15922 28.4778 7.85231 25.3104 7.85231 22.5809C7.85231 20.2781 8.54867 18.1222 9.7399 16.328C9.91387 16.0199 10.1817 15.9663 10.4898 16.2744C10.4898 16.2744 18.4862 24.3637 18.6204 24.4993C18.7545 24.6354 18.8555 24.6557 18.965 24.6557C19.0745 24.6557 19.1755 24.6349 19.3096 24.4993C19.4438 24.3633 27.4402 16.2744 27.4402 16.2744C27.7483 15.9663 28.0161 16.0199 28.1901 16.328C29.3818 18.1222 30.0777 20.2776 30.0777 22.5809C30.0777 25.3109 28.7708 28.4778 27.1055 30.1858C26.7372 30.5636 27.1994 31.0694 27.6677 30.8551C37.931 26.1513 37.93 16.693 37.93 15.0253C37.93 9.19524 34.4487 3.66615 32.0023 1.36379H32.0027Z" fill="#0059FF"/>
                    </svg>
                </div>
                
                <!-- Main Headline -->
                <div class="mb-10">
                    <h1 class="font-heading font-black text-dark-blue mb-2" style="font-size: 92px; line-height: 90%; letter-spacing: -2%;">
                        Suspicious link?
                    </h1>
                    <h2 class="font-heading font-black" style="font-size: 92px; line-height: 90%; letter-spacing: -2%;">
                        <span class="text-primary-blue">Blink</span> 
                        <span class="text-dark-blue">and know.</span>
                    </h2>
                </div>
            </div>

            <!-- Sleek Input Form -->
            <div class="max-w-4xl mx-auto">
                <form id="check-form">
                    <div class="flex bg-white rounded-full shadow-xl p-2 border-2 border-gray-100 hover:border-primary-blue transition-all duration-300">
                        <input type="url"
                               name="url"
                               placeholder="example-suspicious-url.com"
                               required
                               autofocus
                               class="flex-1 px-8 py-4 text-xl font-body text-gray-700 placeholder-gray-400 bg-transparent border-0 focus:outline-none focus:ring-0">
                        <button type="submit"
                                class="bg-primary-blue text-white px-8 py-4 rounded-full hover:bg-dark-blue transition-all duration-300 font-semibold font-body text-lg flex items-center space-x-2 shadow-lg">
                            <span>Check URL</span>
                            <svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7.79167 11.9167C8.95278 11.9167 9.93056 11.5194 10.725 10.725C11.5194 9.93056 11.9167 8.95278 11.9167 7.79167C11.9167 6.63056 11.5194 5.65278 10.725 4.85833C9.93056 4.06389 8.95278 3.66667 7.79167 3.66667C6.63056 3.66667 5.65278 4.06389 4.85833 4.85833C4.06389 5.65278 3.66667 6.63056 3.66667 7.79167C3.66667 8.95278 4.06389 9.93056 4.85833 10.725C5.65278 11.5194 6.63056 11.9167 7.79167 11.9167ZM7.79167 15.5833C5.62222 15.5833 3.78125 14.8271 2.26875 13.3146C0.756251 11.8021 0 9.96111 0 7.79167C0 5.62222 0.756251 3.78125 2.26875 2.26875C3.78125 0.756249 5.62222 -1.90735e-06 7.79167 -1.90735e-06C9.96111 -1.90735e-06 11.8021 0.756249 13.3146 2.26875C14.8271 3.78125 15.5833 5.62222 15.5833 7.79167C15.5833 8.49444 15.484 9.18958 15.2854 9.87708C15.0868 10.5646 14.7889 11.2139 14.3917 11.825L17.9667 15.4C18.3333 15.7667 18.509 16.1944 18.4937 16.6833C18.4785 17.1722 18.2875 17.6 17.9208 17.9667C17.5542 18.3028 17.1264 18.4785 16.6375 18.4938C16.1486 18.509 15.7208 18.3333 15.3542 17.9667L11.825 14.4375C11.2139 14.8347 10.5646 15.125 9.87708 15.3083C9.18958 15.4917 8.49444 15.5833 7.79167 15.5833Z" fill="white"/>
                            </svg>
                        </button>

                            <div id="loading" class="hidden items-center text-primary-blue font-body">
                                <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Analyzing...
                            </div>
                    </div>
                </form>
            </div>
        </div>
        </div>
        
        <!-- Results Section (appears below the form) -->
        <div id="results-section" class="hidden max-w-7xl mx-auto mt-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column (2/3 width) -->
                <div class="lg:col-span-2">

                    <!-- Progress Indicators -->
                    <div id="progress-container" class="bg-white rounded-lg shadow-md p-6 mb-4 hidden">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm font-semibold text-gray-700 font-body">Progress</div>
                            <div class="flex flex-wrap gap-2">
                                <span id="stage-dns" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">DNS</span>
                                <span id="stage-tcp" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">TCP</span>
                                <span id="stage-tls" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">TLS</span>
                                <span id="stage-response" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">Response</span>
                                <span id="stage-scamguard" class="progress-stage px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-600">AI</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="progress-bar" class="progress-bar bg-primary-blue h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <div id="progress-message" class="text-sm text-gray-600 mt-2 font-body"></div>
                    </div>
                </div>

                <!-- ScamGuard Analysis Stream -->
                <div id="scamguard-stream" class="hidden bg-white rounded-lg shadow-md p-6 mb-4 animate-fadeIn">
                    <div class="text-sm font-bold text-gray-800 mb-3 font-heading">AI Security Analysis</div>
                    <div id="scamguard-text" class="text-sm text-gray-700 markdown-content font-body"></div>
                </div>

                <!-- Detailed Results (appears at the end) -->
                <div id="results"></div>
            </div>

            <!-- Right Column (1/3 width) -->
            <div class="lg:col-span-1">
                <!-- Screenshot Section -->
                <div id="screenshot-section" class="hidden bg-white rounded-lg shadow-md p-4 mb-4 animate-fadeIn">
                    <h4 class="text-xs font-bold text-gray-700 mb-2 font-heading">Screenshot</h4>

                    <div class="relative rounded-lg overflow-hidden bg-gray-100" style="width: 100%; aspect-ratio: 16/10;">
                        <!-- BlurHash Canvas (blurred placeholder) -->
                        <canvas
                            id="blurhash-canvas"
                            class="absolute inset-0 w-full h-full object-cover transition-opacity duration-500"
                            style="opacity: 0; filter: blur(20px);"
                        ></canvas>

                        <!-- Actual Screenshot Image (sharp) -->
                        <img
                            id="screenshot-img"
                            class="absolute inset-0 w-full h-full object-cover transition-opacity duration-500"
                            style="opacity: 0;"
                            alt="Screenshot"
                        />

                        <!-- Loading Indicator -->
                        <div id="screenshot-loading"
                             class="absolute inset-0 flex items-center justify-center bg-gray-100">
                            <div class="flex flex-col items-center">
                                <svg class="animate-spin h-6 w-6 text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span class="mt-2 text-xs text-gray-600">Capturing...</span>
                            </div>
                        </div>
                    </div>

                    <div id="screenshot-info" class="text-xs text-gray-500 mt-2 font-body" style="display: none;"></div>
                </div>
            </div>
            </div>
        </div>
    </header>

    <!-- Footer -->
    <div class="text-center text-gray-500 text-sm p-6 font-body">
        <p>Powered by Blink Link Checker API</p>
    </div>

    <script>
        let eventSource = null;
        let scamGuardTextBuffer = ''; // Buffer for accumulating ScamGuard text
        let scamGuardVerdict = ''; // Store verdict separately to avoid duplication
        let timingData = {}; // Collect timing data as it arrives

        // Check if marked.js is loaded
        if (typeof marked === 'undefined') {
            console.error('marked.js library is not loaded!');
        }

        // Store current URL for screenshot functionality
        let currentAnalysisURL = '';

        // Function to handle URL analysis
        function handleURLSubmission(url) {
            if (!url) return;

            // Store URL for screenshot functionality
            currentAnalysisURL = url;

            // Show results section below the form
            document.getElementById('results-section').classList.remove('hidden');

            // Clear previous results and hide sections
            document.getElementById('results').innerHTML = '';
            document.getElementById('screenshot-section').classList.add('hidden');
            timingData = {}; // Reset timing data

            // Show progress and loading
            document.getElementById('progress-container').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '10%';
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loading').classList.add('flex');

            // Reset all stages
            ['dns', 'tcp', 'tls', 'response', 'scamguard'].forEach(stage => {
                const el = document.getElementById('stage-' + stage);
                el.classList.remove('stage-complete', 'stage-active', 'stage-error');
            });

            // Reset and hide ScamGuard stream
            document.getElementById('scamguard-stream').classList.add('hidden');
            document.getElementById('scamguard-text').innerHTML = '';
            scamGuardTextBuffer = '';
            scamGuardVerdict = '';

            // Reset screenshot
            const canvas = document.getElementById('blurhash-canvas');
            const img = document.getElementById('screenshot-img');
            const loading = document.getElementById('screenshot-loading');
            if (canvas) {
                canvas.style.opacity = '0';
                canvas.classList.remove('screenshot-placeholder-hidden');
            }
            if (img) {
                img.src = '';
                img.style.opacity = '0';
                img.classList.remove('screenshot-loaded');
            }
            if (loading) {
                loading.style.display = 'flex';
                loading.innerHTML = '<svg class="animate-spin h-8 w-8 text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="ml-3 text-sm text-gray-600">Capturing screenshot...</span>';
            }

            // Close existing connection
            if (eventSource) {
                eventSource.close();
            }

            // Create EventSource for SSE
            const params = new URLSearchParams({ url: url });
            eventSource = new EventSource('/ui/stream?' + params.toString());

            // Continue with existing event source handlers...
            setupEventSourceHandlers();
        }

        // Handle initial form submission
        document.getElementById('check-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const url = this.querySelector('input[name="url"]').value;
            handleURLSubmission(url);
        });



        // Setup event source handlers
        function setupEventSourceHandlers() {
            // Handle different event types

            // Handle different event types
            eventSource.addEventListener('start', function(e) {
                document.getElementById('progress-message').textContent = 'Starting check...';
                document.getElementById('progress-bar').style.width = '10%';
            });

            eventSource.addEventListener('dns', function(e) {
                const data = JSON.parse(e.data);
                document.getElementById('stage-dns').classList.add('stage-complete');
                document.getElementById('progress-message').textContent = 'DNS resolved (' + data.data.dns_ms + 'ms)';
                document.getElementById('progress-bar').style.width = '30%';
                timingData.dns_ms = data.data.dns_ms; // Store DNS timing
            });

            eventSource.addEventListener('tcp', function(e) {
                const data = JSON.parse(e.data);
                document.getElementById('stage-tcp').classList.add('stage-complete');
                document.getElementById('progress-message').textContent = 'Connected (' + data.data.connect_ms + 'ms)';
                document.getElementById('progress-bar').style.width = '50%';
                timingData.connect_ms = data.data.connect_ms; // Store TCP timing
            });

            eventSource.addEventListener('tls', function(e) {
                const data = JSON.parse(e.data);
                document.getElementById('stage-tls').classList.add('stage-complete');
                document.getElementById('progress-message').textContent = 'TLS handshake complete (' + data.data.tls_ms + 'ms)';
                document.getElementById('progress-bar').style.width = '70%';
                timingData.tls_ms = data.data.tls_ms; // Store TLS timing
            });

            eventSource.addEventListener('response', function(e) {
                const data = JSON.parse(e.data);
                document.getElementById('stage-response').classList.add('stage-complete');
                document.getElementById('progress-message').textContent = 'Got response (status: ' + data.data.status + ')';
                document.getElementById('progress-bar').style.width = '90%';

                // Store TTFB timing
                if (data.data.ttfb_ms) {
                    timingData.ttfb_ms = data.data.ttfb_ms;
                }
                const totalMs = data.data.total_ms;

                // Trigger screenshot loading immediately after response
                document.getElementById('screenshot-section').classList.remove('hidden');
                loadScreenshot(currentAnalysisURL);
            });

            eventSource.addEventListener('redirect', function(e) {
                const data = JSON.parse(e.data);
                document.getElementById('progress-message').textContent = 'Following redirect (hop ' + data.data.hop + ')...';
            });

            // ScamGuard event handlers
            eventSource.addEventListener('scamguard.started', function(e) {
                document.getElementById('stage-scamguard').classList.add('stage-active');
                document.getElementById('scamguard-stream').classList.remove('hidden');
                scamGuardTextBuffer = 'Starting AI analysis...';
                const textEl = document.getElementById('scamguard-text');
                textEl.innerHTML = (typeof marked !== 'undefined') ? marked.parse(scamGuardTextBuffer) : scamGuardTextBuffer;
            });

            eventSource.addEventListener('scamguard.scanning', function(e) {
                scamGuardTextBuffer = 'Analyzing URL for security threats...';
                const textEl = document.getElementById('scamguard-text');
                textEl.innerHTML = (typeof marked !== 'undefined') ? marked.parse(scamGuardTextBuffer) : scamGuardTextBuffer;
            });

            eventSource.addEventListener('scamguard.verdict', function(e) {
                const data = JSON.parse(e.data);
                if (data.data && data.data.verdict) {
                    const verdict = data.data.verdict;

                    // Store the verdict globally for the gauge
                    window.currentVerdict = verdict;

                    switch(verdict) {
                        case 'safe':
                            scamGuardVerdict = '**✓ Verdict: Safe**';
                            break;
                        case 'malicious':
                            scamGuardVerdict = '**⚠ Verdict: Malicious**';
                            break;
                        case 'suspicious':
                            scamGuardVerdict = '**⚠ Verdict: Suspicious**';
                            break;
                        default:
                            scamGuardVerdict = '**Verdict: ' + verdict + '**';
                    }
                    // Don't add verdict to buffer yet - it will be added when displaying

                    // Update verdict gauge if the result is already displayed
                    setTimeout(function() {
                        if (typeof window.updateVerdictGauge === 'function') {
                            window.updateVerdictGauge(verdict);
                        }
                    }, 100);
                }
            });

            eventSource.addEventListener('scamguard.text', function(e) {
                const data = JSON.parse(e.data);
                if (data.data && data.data.text) {
                    // Append text delta to the buffer
                    scamGuardTextBuffer += data.data.text;

                    // Check if the text already contains the verdict to avoid duplication
                    const hasVerdictInText = scamGuardTextBuffer.includes('Verdict:');

                    // Render markdown with verdict at the top (if we have it and it's not already in the text)
                    const textEl = document.getElementById('scamguard-text');
                    const fullText = (scamGuardVerdict && !hasVerdictInText) ?
                        scamGuardVerdict + '\n\n' + scamGuardTextBuffer :
                        scamGuardTextBuffer;

                    if (typeof marked !== 'undefined') {
                        textEl.innerHTML = marked.parse(fullText);
                    } else {
                        // Fallback: convert newlines to <br> tags
                        textEl.innerHTML = fullText.replace(/\n/g, '<br>');
                    }

                    // Auto-scroll to bottom
                    const streamEl = document.getElementById('scamguard-stream');
                    streamEl.scrollTop = streamEl.scrollHeight;
                }
            });

            eventSource.addEventListener('scamguard.completed', function(e) {
                document.getElementById('stage-scamguard').classList.remove('stage-active');
                document.getElementById('stage-scamguard').classList.add('stage-complete');
            });

            eventSource.addEventListener('scamguard.error', function(e) {
                const data = JSON.parse(e.data);
                document.getElementById('stage-scamguard').classList.remove('stage-active');
                document.getElementById('stage-scamguard').classList.add('stage-error');

                const errorMsg = data.data && data.data.error ? data.data.error : 'Analysis failed';
                scamGuardTextBuffer = '⚠ ' + errorMsg;
                const textEl = document.getElementById('scamguard-text');
                textEl.innerHTML = (typeof marked !== 'undefined') ? marked.parse(scamGuardTextBuffer) : scamGuardTextBuffer;
            });

            eventSource.addEventListener('malicious', function(e) {
                // The data contains JSON-encoded HTML - parse it
                try {
                    console.log('Malicious event received:', e.data);
                    const html = JSON.parse(e.data);

                    // Check if html is a string (rendered template) or object (raw data)
                    if (typeof html === 'string') {
                        // It's the rendered HTML template
                        document.getElementById('results').innerHTML = html;

                        // Update verdict gauge directly for malicious URLs
                        setTimeout(function() {
                            const indicator = document.querySelector('.verdict-indicator');
                            const statusEl = document.querySelector('.verdict-status');
                            const textEl = document.querySelector('.verdict-text');

                            if (indicator && statusEl && textEl) {
                                indicator.setAttribute('cx', 20);
                                indicator.setAttribute('cy', 100);
                                statusEl.textContent = 'bad';
                                textEl.textContent = "If you already entered in this website, don't take a risk.";
                            }
                        }, 100);
                    } else if (typeof html === 'object') {
                        // It's raw JSON data - show error message
                        console.error('Received JSON object instead of HTML template:', html);
                        document.getElementById('results').innerHTML = `
                            <div class="bg-red-50 border border-red-200 rounded-md p-4">
                                <div class="flex items-start">
                                    <span class="text-red-600 text-xl mr-2">⚠</span>
                                    <div>
                                        <div class="text-sm font-semibold text-red-800">URL Flagged as Malicious</div>
                                        <div class="text-sm text-red-700 mt-1">${html.error_message || 'This URL was flagged as potentially malicious'}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    // Update verdict gauge if it exists
                    setTimeout(function() {
                        if (typeof window.updateVerdictGauge === 'function') {
                            window.updateVerdictGauge('bad');
                        }
                    }, 100);
                } catch (err) {
                    console.error('Failed to parse malicious event:', err, 'Raw data:', e.data);
                    document.getElementById('results').innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-md p-4">
                            <div class="flex items-start">
                                <span class="text-red-600 text-xl mr-2">⚠</span>
                                <div>
                                    <div class="text-sm font-semibold text-red-800">URL Flagged as Malicious</div>
                                    <div class="text-sm text-red-700 mt-1">This URL was flagged as potentially malicious</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Update UI to show malicious warning
                document.getElementById('progress-bar').style.width = '100%';
                document.getElementById('progress-bar').style.backgroundColor = '#ef4444';
                document.getElementById('progress-message').textContent = 'URL flagged as malicious!';

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('loading').classList.remove('flex');

                // Hide progress after showing malicious warning
                setTimeout(function() {
                    document.getElementById('progress-container').classList.add('hidden');
                    document.getElementById('progress-bar').style.backgroundColor = '';
                }, 3000);

                // Close the connection
                eventSource.close();
                eventSource = null;
            });

            eventSource.addEventListener('complete', function(e) {
                // Parse the complete event data
                try {
                    console.log('Complete event received:', e.data);
                    const data = JSON.parse(e.data);

                    // Check if data is a string (rendered template) or object (raw data)
                    if (typeof data === 'string') {
                        // It's the rendered HTML template - display it
                        document.getElementById('results').innerHTML = data;

                        // Extract verdict from the HTML - look for the verdict assignment in the script
                        let verdictMatch = data.match(/verdict = '(\w+)'/);
                        let detectedVerdict = 'safe'; // default for successful checks

                        if (verdictMatch && verdictMatch[1]) {
                            detectedVerdict = verdictMatch[1];
                        }

                        // Also check if ScamGuard verdict is available
                        if (window.currentVerdict) {
                            detectedVerdict = window.currentVerdict;
                        }

                        console.log('Detected verdict from HTML:', detectedVerdict);

                        // Now manually run the verdict update since scripts don't execute from innerHTML
                        setTimeout(function() {
                            // Find and update the verdict elements directly
                            const indicator = document.querySelector('.verdict-indicator');
                            const statusEl = document.querySelector('.verdict-status');
                            const textEl = document.querySelector('.verdict-text');

                            if (indicator && statusEl && textEl) {
                                let x, y, statusText, descText;

                                switch(detectedVerdict) {
                                    case 'bad':
                                        x = 20; y = 100;
                                        statusText = 'bad';
                                        descText = "If you already entered in this website, don't take a risk.";
                                        break;
                                    case 'safe':
                                        x = 180; y = 100;
                                        statusText = 'safe';
                                        descText = 'No threats detected, this link appears safe.';
                                        break;
                                    default:
                                        x = 100; y = 20;
                                        statusText = 'uncertain';
                                        descText = "Something doesn't look right, proceed carefully.";
                                        break;
                                }

                                indicator.setAttribute('cx', x);
                                indicator.setAttribute('cy', y);
                                statusEl.textContent = statusText;
                                textEl.textContent = descText;
                            }
                        }, 100);

                        // Mark as complete
                        document.getElementById('progress-bar').style.width = '100%';
                        document.getElementById('progress-message').textContent = 'Check complete!';

                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('loading').classList.remove('flex');

                        // Hide progress after showing complete
                        setTimeout(function() {
                            document.getElementById('progress-container').classList.add('hidden');
                        }, 2000);

                        // Close the connection
                        eventSource.close();
                        eventSource = null;
                        return;
                    }

                    // Otherwise handle as raw JSON data (legacy path)
                    console.log('Complete event data (legacy JSON):', data); // Debug log

                    // Update verdict gauge with the final verdict if available
                    setTimeout(function() {
                        if (typeof window.updateVerdictGauge === 'function') {
                            // Use stored verdict from scamguard or default to unknown
                            const finalVerdict = window.currentVerdict || 'unknown';
                            window.updateVerdictGauge(finalVerdict);
                        }
                    }, 100);

                    // Removed TLS and Details sections code as requested

                } catch (err) {
                    console.error('Failed to parse complete event data:', err);
                }

                // Mark as complete
                document.getElementById('progress-bar').style.width = '100%';
                document.getElementById('progress-message').textContent = 'Check complete!';

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('loading').classList.remove('flex');

                // Hide progress after showing complete
                setTimeout(function() {
                    document.getElementById('progress-container').classList.add('hidden');
                }, 2000);

                // Close the connection
                eventSource.close();
                eventSource = null;
            });

            eventSource.addEventListener('error', function(e) {
                // Show error in the results section
                let errorMessage = 'Check failed';
                try {
                    const errorData = JSON.parse(e.data);
                    if (errorData.message) {
                        errorMessage = errorData.message;
                    } else if (typeof errorData === 'string') {
                        // If it's HTML, show it in results
                        document.getElementById('results').innerHTML = errorData;
                    }
                } catch (err) {
                    // Default error message
                }

                document.getElementById('progress-message').textContent = 'Error: ' + errorMessage;
                document.getElementById('progress-bar').style.backgroundColor = '#ef4444';
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('loading').classList.remove('flex');

                // Hide progress after showing error
                setTimeout(function() {
                    document.getElementById('progress-container').classList.add('hidden');
                    document.getElementById('progress-bar').style.backgroundColor = '';
                }, 3000);

                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            });

            // Handle connection errors
            eventSource.onerror = function(e) {
                console.error('EventSource connection error');
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('loading').classList.remove('flex');

                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            };
        }

        // Screenshot Loading Function
        function loadScreenshot(url) {
            const canvas = document.getElementById('blurhash-canvas');
            const img = document.getElementById('screenshot-img');
            const loading = document.getElementById('screenshot-loading');
            const info = document.getElementById('screenshot-info');

            if (!canvas || !img) return;

            // Keep loading state visible
            if (loading) {
                loading.style.display = 'flex';
                loading.innerHTML = '<svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="ml-3 text-sm text-gray-600">Capturing screenshot...</span>';
            }

            // Fetch screenshot with retry logic
            let retryCount = 0;
            const maxRetries = 3;

            function attemptScreenshot() {
                fetch('/screenshot', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url: url, response_type: 'base64'})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.base64_data) {
                        // Step 1: Decode and render blurhash if available
                        if (data.blurhash && data.width && data.height && typeof BlurHash !== 'undefined') {
                            try {
                                const pixels = BlurHash.decode(data.blurhash, 32, 32);
                                canvas.width = 32;
                                canvas.height = 32;
                                const ctx = canvas.getContext('2d');
                                const imageData = ctx.createImageData(32, 32);
                                imageData.data.set(pixels);
                                ctx.putImageData(imageData, 0, 0);
                                canvas.style.opacity = '1';
                                // Hide loading once we have blurhash
                                if (loading) loading.style.display = 'none';
                            } catch (err) {
                                console.error('Failed to decode blurhash:', err);
                            }
                        }

                        // Step 2: Load full screenshot image
                        const newImg = new Image();
                        newImg.onload = function() {
                            img.src = data.base64_data;
                            if (loading) loading.style.display = 'none';

                            // Show info
                            if (info && data.capture_time_ms) {
                                info.textContent = `Screenshot captured in ${data.capture_time_ms}ms`;
                                info.style.display = 'block';
                            }

                            // Fade in sharp image, fade out blur
                            setTimeout(() => {
                                img.classList.add('screenshot-loaded');
                                canvas.classList.add('screenshot-placeholder-hidden');
                            }, 50);
                        };

                        newImg.onerror = function() {
                            // Only show error after retries exhausted
                            if (retryCount >= maxRetries && loading) {
                                loading.innerHTML = '<span class="text-gray-400 text-sm">Screenshot preview not available</span>';
                            }
                        };

                        newImg.src = data.base64_data;
                    } else {
                        // Retry if not successful yet
                        retryCount++;
                        if (retryCount < maxRetries) {
                            setTimeout(attemptScreenshot, 2000); // Retry after 2 seconds
                        } else if (loading) {
                            // Only show error message after all retries
                            loading.innerHTML = '<span class="text-gray-400 text-sm">Screenshot preview not available</span>';
                        }
                    }
                })
                .catch(err => {
                    console.error('Failed to fetch screenshot:', err);
                    retryCount++;
                    if (retryCount < maxRetries) {
                        setTimeout(attemptScreenshot, 2000); // Retry after 2 seconds
                    } else if (loading) {
                        loading.innerHTML = '<span class="text-gray-400 text-sm">Screenshot preview not available</span>';
                    }
                });
            }

            // Start the first attempt
            attemptScreenshot();
        }
    </script>
</body>
</html>
